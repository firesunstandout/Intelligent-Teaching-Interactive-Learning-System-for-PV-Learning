<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PV Power Generation Interactive Teaching</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="style-extra.css">
    <!-- Google Fonts for a modern look -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
</head>

<body>
    <header>
        <div class="logo">PV Learning</div>
        <nav>
            <ul>
                <li><a href="#home" class="active" data-target="home">Home</a></li>
                <li><a href="#animation" data-target="animation">Principle Demo</a></li>
                <li><a href="#experiment" data-target="experiment">Virtual Labs</a></li>
                <li><a href="#knowledge" data-target="knowledge">Knowledge Cards</a></li>
                <li><a href="#knowledge-graph" data-target="knowledge-graph">Knowledge Graph</a></li>
                <li><a href="#qa" data-target="qa">Smart Q&A</a></li>
                <li><a href="#practice" data-target="practice">Self Test</a></li>
                <li><a href="#ranking" data-target="ranking">Class Ranking</a></li>
            </ul>
        </nav>
        <div class="user-status" id="user-status-display">
            <span>Progress: <span id="progress-percent">0%</span></span>
        </div>
    </header>

    <main>
        <!-- Home Section -->
        <section id="home" class="active-section">
            <div class="hero">
                <h1>Explore the Secrets of PV Power</h1>
                <p>From photons to current, an end-to-end interactive learning platform</p>
                <button class="cta-btn" onclick="navigateTo('animation')" style="margin-top: 20px;">Start Learning</button>
            </div>
            <div class="scenarios">
                <h2>Typical Application Scenarios</h2>
                <div class="scenario-grid">
                    <div class="scenario-card">
                        <img src="roof_solar.png" alt="Distributed Rooftop PV"
                            style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                        <h3>Distributed Rooftop PV</h3>
                        <p>Use idle rooftops for self-consumption and feed surplus to the grid.</p>
                    </div>
                    <div class="scenario-card">
                        <img src="ground_solar.png" alt="Utility-Scale Ground Plant"
                            style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                        <h3>Utility-Scale Ground Plant</h3>
                        <p>Build at scale, connect at high voltage, and generate centrally.</p>
                    </div>
                    <div class="scenario-card">
                        <img src="bipv_solar.png" alt="Building-Integrated PV"
                            style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">
                        <h3>Building-Integrated PV (BIPV)</h3>
                        <p>PV modules as building materials‚Äîfunction and aesthetics combined.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Animation Section -->
        <section id="animation">
            <h2>PV Power Principle Demo</h2>
            <div class="animation-container">
                <div class="animation-viewport">
                    <canvas id="pv-canvas" width="800" height="500"></canvas>
                </div>
                <div class="controls">
                    <button id="play-btn" class="control-btn">
                        <span class="btn-icon">‚ñ∂</span>
                        <span class="btn-label">Play / Pause</span>
                    </button>
                    <button id="reset-btn" class="control-btn ghost">
                        <span class="btn-icon">‚Ü∫</span>
                        <span class="btn-label">Reset</span>
                    </button>
                </div>
                <div class="step-indicators" id="step-indicators">
                    <!-- Generated by JS -->
                </div>
                <div class="animation-info" id="animation-info">
                    Click play to start the demo...
                </div>
            </div>
        </section>

        <!-- Experiment Section -->
        <section id="experiment">
            <h2>Virtual Experiments</h2>

            <!-- Experiment 1: I-V Characteristics -->
            <div class="experiment-wrapper">
                <h3>Experiment 1: PV I-V Characteristic Curve</h3>
                <div class="experiment-container">
                    <div class="exp-controls">
                        <div class="control-group">
                            <label>Irradiance (G): <span id="val-g">1000</span> W/m¬≤</label>
                            <input type="range" id="slider-g" min="200" max="1200" step="50" value="1000">
                        </div>
                        <div class="control-group">
                            <label>Cell Temperature (T): <span id="val-t">25</span> ¬∞C</label>
                            <input type="range" id="slider-t" min="0" max="75" step="1" value="25">
                        </div>
                        <div class="exp-stats">
                            <p>Open-Circuit Voltage (Voc): <span id="res-voc">--</span> V</p>
                            <p>Short-Circuit Current (Isc): <span id="res-isc">--</span> A</p>
                            <p>Maximum Power (Pmax): <span id="res-pmax">--</span> W</p>
                        </div>
                    </div>
                    <div class="exp-canvas-wrapper">
                        <canvas id="iv-canvas" width="600" height="400"></canvas>
                    </div>
                </div>
            </div>

            <!-- Experiment 2: Angle of Incidence -->
            <div class="experiment-wrapper">
                <h3>Experiment 2: Effect of Incidence Angle on Efficiency</h3>
                <div class="experiment-container">
                    <div class="exp-controls">
                        <div class="control-group">
                            <label>Incidence Angle (Œ∏): <span id="val-angle">0</span>¬∞</label>
                            <input type="range" id="slider-angle" min="0" max="90" step="5" value="0">
                            <small>0¬∞ = perpendicular to the panel, 90¬∞ = parallel to the surface</small>
                        </div>
                        <div class="control-group">
                            <label>Irradiance: <span id="val-g2">1000</span> W/m¬≤</label>
                            <input type="range" id="slider-g2" min="200" max="1200" step="50" value="1000">
                        </div>
                        <div class="exp-stats">
                            <p>Effective Irradiance: <span id="res-eff-irr">--</span> W/m¬≤</p>
                            <p>Relative Efficiency: <span id="res-efficiency">--</span>%</p>
                            <p>Output Power: <span id="res-power">--</span> W</p>
                        </div>
                    </div>
                    <div class="exp-canvas-wrapper">
                        <canvas id="angle-canvas" width="600" height="400"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Knowledge Cards Section -->
        <section id="knowledge">
            <h2>Core Knowledge Points</h2>
            <div class="cards-grid" id="cards-container">
                <!-- Generated by JS -->
            </div>
        </section>

        <!-- Knowledge Graph Section -->
        <section id="knowledge-graph">
            <h2>PV Knowledge Graph</h2>
            <div class="graph-wrapper">
                <div class="graph-intro" id="graph-intro">
                    <p>Click the button below to generate a PV knowledge graph and explore the links.</p>
                    <button id="generate-graph-btn" class="cta-btn">Generate Knowledge Graph</button>
                </div>
                <div id="graph-container-wrapper" style="display: none; position: relative;">
                    <div id="graph-loading" class="loading-overlay">
                        <div class="spinner"></div>
                        <div class="loading-text">Initializing...</div>
                    </div>
                    <div id="main-graph"
                        style="width: 100%; height: 600px; background-color: #0b0f19; border-radius: 16px;"></div>
                    <div class="legend-info"
                        style="position: absolute; top: 20px; left: 20px; color: #ccc; background: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; pointer-events: none; border: 1px solid rgba(255,255,255,0.1);">
                        <h1
                            style="font-size: 20px; margin: 0 0 10px 0; color: #fff; text-shadow: 0 0 10px rgba(0,210,255,0.5);">
                            PV Knowledge Graph</h1>
                        <p style="font-size: 12px; margin: 5px 0; color: #aaa;">‚óè Drag nodes to reposition</p>
                        <p style="font-size: 12px; margin: 5px 0; color: #aaa;">‚óè Hover to view relationships</p>
                        <p style="font-size: 12px; margin: 5px 0; color: #aaa;">‚óè Scroll to zoom in/out</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Q&A Section -->
        <section id="qa">
            <h2>Interactive Q&A</h2>
            <div class="qa-container">
                <div class="chat-window" id="chat-window">
                    <div class="message ai-message">
                        Hello! I'm your PV teaching assistant. Click a suggested question below or ask anything about solar PV.
                    </div>
                </div>
                <div class="input-area">
                    <input type="text" id="user-input" placeholder="Type your question...">
                    <button id="send-btn">Send</button>
                </div>
                <div class="recommended-questions" id="recommended-questions">
                    <!-- Generated by JS -->
                </div>
            </div>
        </section>

        <!-- Practice Section -->
        <section id="practice">
            <h2>Self Test</h2>
            <div class="quiz-container" id="quiz-container">
                <!-- Generated by JS -->
            </div>
            <div id="quiz-result" class="hidden">
                <h3>Quiz Complete!</h3>
                <p>Your Score: <span id="score-display">0</span></p>
                <button onclick="resetQuiz()">Try Again</button>
            </div>
        </section>

        <!-- Ranking Section -->
        <section id="ranking">
            <h2>Class Leaderboard</h2>
            <div class="ranking-container">
                <div class="teacher-push" id="teacher-push">
                    <strong>üì¢ Teacher Notice:</strong> <span id="push-msg">Today's assignment is live‚Äîplease finish before 22:00.</span>
                </div>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Score</th>
                            <th>Badge</th>
                        </tr>
                    </thead>
                    <tbody id="ranking-body">
                        <!-- Generated by JS -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 PV Learning Interactive. All Rights Reserved.</p>
    </footer>

    <script src="data.js"></script>
    <script src="script.js"></script>

    <!-- Hidden Export Logic (Inline to avoid caching issues) -->
    <script>
        console.log('Inline script loaded: Initializing hidden export logic...');

        function initHiddenExport() {
            const footer = document.querySelector('footer p');
            if (!footer) {
                console.warn('Footer not found for hidden export');
                return;
            }

            // Prevent text selection to make clicking easier
            footer.style.userSelect = 'none';
            footer.style.webkitUserSelect = 'none';
            footer.style.cursor = 'pointer'; // Visual cue

            let clickCount = 0;
            let clickTimer = null;

            footer.addEventListener('click', (e) => {
                clickCount++;
                console.log(`Magic Click: ${clickCount}/5`);

                if (clickTimer) clearTimeout(clickTimer);

                clickTimer = setTimeout(() => {
                    if (clickCount > 0 && clickCount < 5) {
                        console.log('Magic Click reset');
                    }
                    clickCount = 0;
                }, 3000); // Relaxed to 3 seconds

                if (clickCount >= 5) {
            const msg = document.createElement('div');
            msg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.8);color:white;padding:20px;border-radius:8px;z-index:10000;font-size:16px;font-weight:500;box-shadow:0 4px 12px rgba(0,0,0,0.2);backdrop-filter:blur(5px);';
            msg.innerHTML = '<span style="margin-right:8px">üîí</span>Admin privileges activated';
            document.body.appendChild(msg);
            setTimeout(() => {
                msg.style.opacity = '0';
                msg.style.transition = 'opacity 0.5s';
                setTimeout(() => msg.remove(), 500);
                showDownloadButton();
            }, 1500);
            clickCount = 0;
            if (clickTimer) clearTimeout(clickTimer);
        }
            });
        }

        function showDownloadButton() {
            if (document.getElementById('teacher-download-btn')) return;

            const btn = document.createElement('button');
            btn.id = 'teacher-download-btn';
            btn.textContent = 'üì• Export Teaching Data';
            btn.style.position = 'fixed';
            btn.style.bottom = '20px';
            btn.style.right = '20px';
            btn.style.zIndex = '9999';
            btn.style.padding = '12px 24px';
            btn.style.backgroundColor = '#007AFF';
            btn.style.color = 'white';
            btn.style.border = 'none';
            btn.style.borderRadius = '25px';
            btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            btn.style.cursor = 'pointer';
            btn.style.fontWeight = 'bold';
            btn.style.fontFamily = '"Noto Sans SC", sans-serif';
            btn.style.transition = 'all 0.3s ease';

            btn.onmouseover = () => {
                btn.style.transform = 'translateY(-2px)';
                btn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.3)';
            };
            btn.onmouseout = () => {
                btn.style.transform = 'translateY(0)';
                btn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
            };

            btn.onclick = downloadData;

            document.body.appendChild(btn);
        }

        function downloadData() {
            const qaData = JSON.parse(localStorage.getItem('pv_qa_history') || '[]');
            const quizData = JSON.parse(localStorage.getItem('pv_quiz_history') || '[]');

            const exportData = {
                exportTime: new Date().toISOString(),
                qaLogs: qaData,
                quizLogs: quizData
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `pv_learning_data_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Initialize immediately
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initHiddenExport);
        } else {
            initHiddenExport();
        }
    </script>
</body>

</html>